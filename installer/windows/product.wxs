<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

    <?include variables.wxi ?>

    <Product Id="*" UpgradeCode="$(var.UpgradeCode)" Name="$(var.ProductName)" Manufacturer="$(var.Team)" Version="$(var.Version)" Language="1033">

        <Package Id="*" Compressed="yes" InstallerVersion="301" InstallScope="perMachine" />

        <Media Id="1" Cabinet="Media.cab" EmbedCab="yes" CompressionLevel="high" />

        <!--
        Schedule="afterInstallInitialize"
            Removes the installed product first then installs the new version, if the installation of the new version
            fails, Windows Installer also rolls back the removal of the installed product, in other words, reinstalls it.

        AllowSameVersionUpgrades="yes"
            When upgrading products (using the same "UpgradeCode"), Windows Installer only check the first three version
            fields (Major.Minor.Patch) to decide if it should upgrade the product or not. The nightly build version never
            change and therefore "AllowSameVersionUpgrades" is required if we want to be able to update the installed
            nightly version.
        -->
        <MajorUpgrade
            Schedule="afterInstallInitialize"
            AllowSameVersionUpgrades="yes"
            DowngradeErrorMessage="A later version of $(var.ProductName) is already installed. Setup will now exit."
        />

        <!-- ========================================= Add/Remove Programs ========================================= -->

        <Icon Id="app.ico" SourceFile="$(var.AppIcon)" />
        <Property Id="ARPPRODUCTICON" Value="app.ico" />
        <Property Id='ARPCOMMENTS' Value="$(var.AppComments)" />
        <Property Id='ARPCONTACT' Value="$(var.AppContact)" />
        <Property Id='ARPREADME' Value="$(var.AppReadme)" />
        <Property Id="ARPHELPLINK" Value="$(var.AppHelpLink)" />
        <Property Id="ARPURLINFOABOUT" Value="$(var.AppSupportLink)" />
        <Property Id="ARPURLUPDATEINFO" Value="$(var.AppUpdateInfoLink)" />
        <SetProperty Id="ARPINSTALLLOCATION" Value="[INSTALLDIR]" After="CostFinalize" />

        <!-- ================================================ Files ================================================ -->

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Merge Id="VCRedist" SourceFile="$(var.VCRedistPath)\$(var.VCRedistFile)" DiskId="1" Language="0" />
            <Directory Id="ProgramMenuFolder" />
            <Directory Id="$(var.ProgramFilesFolder)">
                <Directory Id="INSTALLDIR" Name="$(var.Name)">
                    <Directory Id="imageformats" Name="imageformats">
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qgif.dll" /></Component>
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qicns.dll" /></Component>
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qico.dll" /></Component>
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qjpeg.dll" /></Component>
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qsvg.dll" /></Component>
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qtga.dll" /></Component>
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qtiff.dll" /></Component>
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qwbmp.dll" /></Component>
                        <Component><File Source="$(var.QtPath)\plugins\imageformats\qwebp.dll" /></Component>
                    </Directory>
                    <Directory Id="platforms" Name="platforms">
                        <Component><File Source="$(var.QtPath)\plugins\platforms\qwindows.dll" /></Component>
                    </Directory>
                    <Directory Id="licenses" Name="licenses">
                        <Component><File Source="..\..\LICENSE" /></Component>
                        <Component><File Source="..\..\LICENSE-PLUGINS" /></Component>
                    </Directory>
                    <Component><File Source="$(var.QtPath)\bin\Qt5Concurrent.dll" /></Component>
                    <Component><File Source="$(var.QtPath)\bin\Qt5Core.dll" /></Component>
                    <Component><File Source="$(var.QtPath)\bin\Qt5Gui.dll" /></Component>
                    <Component><File Source="$(var.QtPath)\bin\Qt5Network.dll" /></Component>
                    <Component><File Source="$(var.QtPath)\bin\Qt5PrintSupport.dll" /></Component>
                    <Component><File Source="$(var.QtPath)\bin\Qt5Widgets.dll" /></Component>
                    <Component><File Source="$(var.QtPath)\bin\Qt5Xml.dll" /></Component>
                    <Component><File Source="$(var.OpenSSLPath)\libeay32.dll" /></Component>
                    <Component><File Source="$(var.OpenSSLPath)\ssleay32.dll" /></Component>
                    <Component><File Source="$(var.SQLitePath)\sqlite3.dll" /></Component>
                    <Component>
                        <File Source="..\..\Release\DB Browser for SQLite.exe" Checksum="yes" KeyPath="yes">
                            <Shortcut
                                Id="StartMenuShortcut"
                                Name="$(var.ProductName)"
                                Description="$(var.AppComments)"
                                Directory="ProgramMenuFolder"
                                WorkingDirectory="INSTALLDIR"
                                Icon="app.ico"
                            />
                        </File>
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <!-- ============================================== Features =============================================== -->

        <Feature Id="VCRedist" Title="Visual C++ Runtime" AllowAdvertise="no" Display="hidden" Level="1">
            <MergeRef Id="VCRedist"/>
        </Feature>

        <Feature Id="Complete" Level="1">
            <!-- Plugins -->
            <ComponentRef Id="qgif.dll" />
            <ComponentRef Id="qicns.dll" />
            <ComponentRef Id="qico.dll" />
            <ComponentRef Id="qjpeg.dll" />
            <ComponentRef Id="qsvg.dll" />
            <ComponentRef Id="qtga.dll" />
            <ComponentRef Id="qtiff.dll" />
            <ComponentRef Id="qwbmp.dll" />
            <ComponentRef Id="qwebp.dll" />
            <!-- Platforms -->
            <ComponentRef Id="qwindows.dll" />
            <!-- Licenses -->
            <ComponentRef Id="LICENSE" />
            <ComponentRef Id="LICENSE_PLUGINS" />
            <!-- Qt -->
            <ComponentRef Id="Qt5Concurrent.dll" />
            <ComponentRef Id="Qt5Core.dll" />
            <ComponentRef Id="Qt5Gui.dll" />
            <ComponentRef Id="Qt5Network.dll" />
            <ComponentRef Id="Qt5PrintSupport.dll" />
            <ComponentRef Id="Qt5Widgets.dll" />
            <ComponentRef Id="Qt5Xml.dll" />
            <!-- OpenSSL -->
            <ComponentRef Id="libeay32.dll" />
            <ComponentRef Id="ssleay32.dll" />
            <!-- SQLite -->
            <ComponentRef Id="sqlite3.dll" />
            <!-- Application -->
            <ComponentRef Id="DB_Browser_for_SQLite.exe" />
        </Feature>

    <!-- ============================================= Installation UI ============================================= -->

        <!-- Dialog Set -->
        <UIRef Id="WixUI_InstallDir" />

        <!-- Default installation directory -->
        <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />

        <!-- License file -->
        <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

        <!-- Banner image -->
        <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />

        <!-- Optional text, shown at the end of installation -->
        <Property Id="WIXUI_EXITDIALOGOPTIONALTEXT" Value="Thank you for installing $(var.Name)." />

    <!-- ===================================== Run the application after setup ===================================== -->
    <!--   http://wixtoolset.org/documentation/manual/v3/howtos/ui_and_localization/run_program_after_install.html   -->

        <!-- Step 1: Add the checkbox, and select it, at the end of installation -->
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Run $(var.Name)" />
        <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />

        <!-- Step 2: Include the custom Action -->
        <Property Id="WixShellExecTarget" Value="[#DB_Browser_for_SQLite.exe]" />
        <CustomAction Id="LaunchApplication" BinaryKey="WixCA" DllEntry="WixShellExec" Impersonate="yes" />

        <!-- Step 3: Trigger the custom action -->
        <UI><Publish Control="Finish" Dialog="ExitDialog" Event="DoAction" Value="LaunchApplication">WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 and NOT Installed</Publish></UI>

    </Product>

</Wix>
